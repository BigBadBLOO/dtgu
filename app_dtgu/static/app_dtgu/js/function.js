var agLocaleText = {
    // for filter panel
    page: '&nbsp;',
    more: 'Больше',
    to: 'до',
    of: 'из',
    next: 'Следующий',
    last: 'Последний',
    first: 'Первый',
    previous: 'Предыдущий',
    loadingOoo: 'Загрузка...',

    // for set filter
    selectAll: 'Выбрать всё',
    searchOoo: 'Поиск...',
    blanks: 'Пусто',

    // for number filter and text filter
    filterOoo: 'Поиск...',
    applyFilter: 'Применить...',
    equals: 'Равно',
    notEqual: 'Не равно',

    // for number filter
    lessThan: 'Меньше чем',
    greaterThan: 'Больше чем',
    lessThanOrEqual: 'Меньше или равно',
    greaterThanOrEqual: 'Больше или равно',
    inRange: 'Больше, но меньше',

    // for text filter
    contains: 'Содержит',
    notContains: 'Не содержит',
    startsWith: 'Начинается с',
    endsWith: 'Заканчивается на',

    // filter conditions
    andCondition: 'И',
    orCondition: 'ИЛИ',

    // the header of the default group column
    group: 'Группа',

    // tool panel
    columns: 'Столбцы',
    filters: 'Фильтр',
    rowGroupColumns: 'laPivot Cols',
    rowGroupColumnsEmptyMessage: 'Перетащите столбцы для группировки',
    valueColumns: 'Значения столбцов',
    pivotMode: 'laPivot-Mode',
    groups: 'Группы',
    values: 'Значения',
    pivots: 'laPivots',
    valueColumnsEmptyMessage: 'Перетащите столбцы для группировки',
    pivotColumnsEmptyMessage: 'la drag here to pivot',
    toolPanelButton: 'Панель инструментов',

    // other
    noRowsToShow: 'Нет записей...',

    // enterprise menu
    pinColumn: 'Закрепить столбец',
    valueAggregation: 'laValue Agg',
    autosizeThiscolumn: 'laAutosize Diz',
    autosizeAllColumns: 'laAutsoie em All',
    groupBy: 'Сгрупировать',
    ungroupBy: 'Разгрупировать',
    resetColumns: 'laReset Those Cols',
    expandAll: 'laOpen-em-up',
    collapseAll: 'laClose-em-up',
    toolPanel: 'Панель инструментов',
    export: 'Экспорт данных',
    csvExport: 'Экспорт данных в формате (.cvs)',
    excelExport: 'Экспорт данных в формате (.xlsx)',
    excelXmlExport: 'Экспорт данных в формате (.xml)',

    // enterprise menu (charts)

    chartRange: 'laChart Range',

    columnRangeChart: 'laColumn',
    groupedColumnChart: 'laGrouped',
    stackedColumnChart: 'laStacked',
    normalizedColumnChart: 'la100% Stacked',

    barRangeChart: 'laBar',
    groupedBarChart: 'laGrouped',
    stackedBarChart: 'laStacked',
    normalizedBarChart: 'la100% Stacked',

    lineRangeChart: 'laLine',

    pieRangeChart: 'laPie',
    pieChart: 'laPie',
    doughnutChart: 'laDoughnut',

    areaRangeChart: 'laArea',
    areaChart: 'laArea',
    stackedAreaChart: 'laStacked',
    normalizedAreaChart: 'la100% Stacked',

    // enterprise menu pinning
    pinLeft: '<<',
    pinRight: '>>',
    noPin: '<>',

    // enterprise menu aggregation and status bar
    sum: 'Сумма',
    min: 'Минимум',
    max: 'Максимум',
    none: 'Отсутствует',
    count: 'Количество',
    average: 'Среднее',
    filteredRows: 'Фильтрация записей',
    selectedRows: 'Вывор записей',
    totalRows: 'Всего записей',
    totalAndFilteredRows: 'Записей',

    // standard menu
    copy: 'Копировать',
    copyWithHeaders: 'Копировать вместе с шапкой',
    ctrlC: 'ctrl + c',
    paste: 'Вставить',
    ctrlV: 'ctrl + v',

    // charts
    settings: 'Настройки',
    data: 'Данные',
    format: 'Формат',
    categories: 'Категории',
    series: 'laSeries',
    axis: 'laAxis',
    color: 'laColor',
    thickness: 'laThickness',
    xRotation: 'laX Rotation',
    yRotation: 'laY Rotation',
    ticks: 'laTicks',
    width: 'laWidth',
    length: 'laLength',
    padding: 'laPadding',
    chart: 'laChart',
    title: 'laTitle',
    font: 'laFont',
    top: 'laTop',
    right: 'laRight',
    bottom: 'laBottom',
    left: 'laLeft',
    labels: 'laLabels',
    size: 'laSize',
    legend: 'laLegend',
    position: 'laPosition',
    markerSize: 'laMarker Size',
    markerStroke: 'laMarker Stroke',
    markerPadding: 'laMarker Padding',
    itemPaddingX: 'laItem Padding X',
    itemPaddingY: 'laItem Padding Y',
    strokeWidth: 'laStroke Width',
    offset: 'laOffset',
    tooltips: 'laTooltips',
    offsets: 'laOffsets',
    callout: 'laCallout',
    markers: 'laMarkers',
    shadow: 'laShadow',
    blur: 'laBlur',
    xOffset: 'laX Offset',
    yOffset: 'laY Offset',
    lineWidth: 'laLine Width',
    normal: 'laNormal',
    bold: 'laBold',
    italic: 'laItalic',
    boldItalic: 'laBold Italic',
    fillOpacity: 'laFill Opacity',
    strokeOpacity: 'laLine Opacity',
    groupedColumnTooltip: 'laGrouped',
    stackedColumnTooltip: 'laStacked',
    normalizedColumnTooltip: 'la100% Stacked',
    groupedBarTooltip: 'laGrouped',
    stackedBarTooltip: 'laStacked',
    normalizedBarTooltip: 'la100% Stacked',
    pieTooltip: 'laPie',
    doughnutTooltip: 'laDoughnut',
    lineTooltip: 'laLine',
    groupedAreaTooltip: 'laGrouped',
    stackedAreaTooltip: 'laStacked',
    normalizedAreaTooltip: 'la100% Stacked'
};

Array.prototype.insert = function (index, item) {
    this.splice(index, 0, item);
};

String.prototype.cut_text = function (len) {
    if (this.length > len) {
        return this.substr(0, len - 3) + '...';
    } else {
        return this.concat();
    }
};


function columnWidth(id, percentage) {
    var div = $("#" + id);  // HTML ID of Grid
    var parent = div.parent();
    return parent.width() * percentage / 100;
}

function disable_button(modal_id, acces_elem_id) {
    if ($(modal_id + " div.has-error").length === 0) {
        $(acces_elem_id + "").attr("disabled", false)
    } else {
        $(acces_elem_id + "").attr("disabled", true)
    }
}

function make_selector(list, empty = false) {
    var result = '';
    result += empty ? '<option value=""></option>' : '';
    for (var i = 0; i < list.length; i++) {
        result += '<option value="' + list[i]['id'] + '"';
        if (list[i]['show']) {
            result += ' selected="selected" ';
        }
        result += '>';
        result += list[i]['name'];
        result += '</option>';
    }
    return result;
}

function add_to_selector(list) {
    var result = '<option value="' + list['id'] + '"';
    if (list['show']) {
        result += ' selected="selected" ';
    }
    result += '>';
    result += list['name'];
    result += '</option>';
    return result;
}

function get_lead_page(data, status=null, flow=null,landing=null) {
    $.cookie('ads_id', data, {path: '/leads_control',expires: 1000});
    if(status !== null){
      $.cookie('ads_status', status, {path: '/leads_control'});
    }
    if(flow !== null){
      $.cookie('flow', flow, {path: '/leads_control'});
    }
    if(landing !== null){
      $.cookie('landing', landing, {path: '/leads_control'});
    }
    window.open('/leads_control', '_blank');
}

function search_in_json(list, key, value) {
    for (var i = 0; i < list.length; i++) {
        if (list[i][key] == value) {
            return list[i];
        }
    }
    return null;
}

function search_list_in_json(list, key, value) {
    var result = [];
    if (value !== undefined) {
        for (var i = 0; i < list.length; i++) {
            if (list[i][key] == value) {
                result.push(list[i]);
            }
        }
    }
    return result;
}

function search_list_in_json_with_arr(list, key, value) {
    var result = [];
    if (value !== undefined) {
        for (var i = 0; i < list.length; i++) {
            for(var j = 0; j < list[i][key].length; j++){
                if (list[i][key][j] == value) {
                    result.push(list[i]);
                }
            }

        }
    }
    return result;
}

function search_list_in_json_with_date(list, key, date, tz) {
    var result = [];
    if (date !== undefined) {
        var date_min = new Date(date);
        var date_max = new Date(date);
        date_max.setHours(date_max.getHours() + 24);
        for (var i = 0; i < list.length; i++) {
            if (date_format(list[i][key], tz) >= date_min && date_format(list[i][key], tz) < date_max) {
                result.push(list[i]);
            }
        }
    }
    return result;
}

function search_list_in_json_with_date_month(list, key, year, month, day_min=null, day_max=null, tz) {
    var result = [];
    if (list !== undefined) {
        var date_min = new Date(year, month -1, 1);

        if(day_min !== null){
            date_min = day_min
        }

        var date_max = new Date(year, month, 0);

        if(day_max !== null){
            date_max = day_max
        }
        date_max.setHours(date_max.getHours() + 24);

        for (var i = 0; i < list.length; i++) {
            if (date_format(list[i][key], tz) >= date_min && date_format(list[i][key], tz) < date_max) {
                result.push(list[i]);
            }
        }
    }
    return result;
}

function search_list_in_json_by_arr(list, key, arr) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (is_in_array(list[i][key], arr)) {
            result.push(list[i]);
        }
    }
    return result;
}

function search_list_not_in_json_by_arr(list, key, arr) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (!is_in_array(list[i][key], arr)) {
            result.push(list[i]);
        }
    }
    return result;
}

function update_in_json(list, key, value, param_key, param_value) {
    for (var i = 0; i < list.length; i++) {
        if (list[i][key] == value) {
            list[i][param_key] = param_value;
        }
    }
    return list;
}

function remove_from_json(list, key, value) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (list[i][key] !== value) {
            result.push(list[i]);
        }
    }
    return result;
}

function remove_list_from_json(list, key, arr) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (!is_in_array(list[i][key], arr)) {
            result.push(list[i]);
        }
    }
    return result;
}

function get_list_of_elems(list, key) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        result.push(list[i][key]);
    }
    return result;
}

function make_tree_node(list) {
    var result = [];
    for (var i=0; i < list.length; i++){
        result.push({
            'text': '<span class="clip" style="max-width: calc(100% - 100px);">' + list[i]['name'] + '</span>',
            'type': 'form',
            'pk': list[i]['id'],
        })
    }
    return result
}
function get_list_as_array(list) {
    var result = [];
    for (var i in list) {
        result.push(list[i]);
    }
    return result;
}

function add_to_array(list, value) {
    if (!is_in_array(value, list)) {
        list.push(value)
    }
    return list;
}

function remove_from_array(list, value) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (list[i] !== value) {
            result.push(list[i]);
        }
    }
    return result;
}

function remove_array_from_array(list, array) {
    for (var i = 0; i < array.length; i++) {
        list = remove_from_array(list, array[i]);
    }
    return list;
}


function remove_from_array_list(list, arr) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        if (!is_in_array(list[i], arr)) {
            result.push(list[i]);
        }
    }
    return result;
}

function open_many_to_many(list) {
    var result = [];
    for (var i = 0; i < list.length; i++) {
        list[i]['fields']['id'] = list[i]['pk'];
        result.push(list[i]['fields']);
    }
    return result;
}

function compare_obj(obj, pattern) {
    for (var i in pattern) {
        if (pattern[i] !== obj[i]) {
            return false;
        }
    }
    return true;
}

function is_in_array(x, arr) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] == x) {
            return true;
        }
    }
    return false;
}

function show_load() {
    $('#load-panel').show();
}

function hide_load() {
    $('#load-panel').hide();
}

function copy_obj(obj) {
    return JSON.parse(JSON.stringify(obj));
}

function ajax_message(url, data, funct) {
    $.ajax({
        url: url,
        type: 'POST',
        data: data,
        dataType: 'JSON',
        success: function (data) {
            hide_load();
            // data = JSON.parse(data);
            if (typeof data['text_error'] !== 'undefined') {
                show_global_alert('danger', data['text_error'], 0);
            }
            if (typeof data['text_success'] !== 'undefined') {
                show_global_alert('success', data['text_success'], 2);
            }
            if (typeof data['reload'] !== 'undefined' && data['reload'] === true) {
                window.location.reload();
            }
            if (typeof data['unauthorized'] !== 'undefined' && data['unauthorized'] === true) {
                window.location.href = '/';
            }
            if (typeof data['unactive'] !== 'undefined' && data['unactive'] === true) {
                logout();
            }
            if ((typeof funct === 'function') && (typeof data['text_error'] === 'undefined')) {
                funct(data);
            }
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            hide_load();
            show_global_alert('danger', "<b>Status:</b> " + textStatus, 2);
        }
    })
}


function date_format(textdate, timezone) {
    timezone = timezone === undefined ? null : timezone;
    if (textdate === null || textdate === undefined || textdate.length === 0) {
        return null;
    }
    var result = new Date(textdate);
    var currentTimeZoneOffsetInHours = result.getTimezoneOffset() / 60;
    if (timezone !== null) {
        var hours = is_int(timezone.hours) ? Number(timezone.hours) : 0;
        var minutes = is_int(timezone.minutes) ? Number(timezone.minutes) : 0;
        if (timezone.minus) {
            result.setHours(result.getHours() - hours + currentTimeZoneOffsetInHours);
            result.setMinutes(result.getMinutes() - minutes);
        } else {
            result.setHours(result.getHours() + hours + currentTimeZoneOffsetInHours);
            result.setMinutes(result.getMinutes() + minutes);
        }
    }
    return result;
}

function to_date_format(datetime) {
    if (datetime === null) {
        return null;
    }
    return get_two(datetime.getDate()) + '.' + get_two(datetime.getMonth() + 1) + '.' + datetime.getFullYear()
}

function to_datetime_format(datetime) {
    if (datetime === null) {
        return null;
    }
    return get_two(datetime.getHours()) + ':' + get_two(datetime.getMinutes()) + ' ' + get_two(datetime.getDate()) + '.' + get_two(datetime.getMonth() + 1) + '.' + datetime.getFullYear()
}

function to_date_input_format(datetime) {
    if (datetime === null) {
        return null;
    }
    return get_two(datetime.getDate()) + '.' + get_two(datetime.getMonth() + 1) + '.' + datetime.getFullYear()
}

function get_two(number) {
    return number < 10 ? '0' + number : number % 100;
}

function is_int(x) {
    return Number(x) === Number(x);
}

function is_date(x) {
    return Date.parse(x) === Date.parse(x);
}

function score_summ(score, scoreOffers) {
    var result = 0;
    for (var i = 0; i < score.length; i++) {
        var score_offers = search_list_in_json(scoreOffers,'score_id',score[i]['id']);
         for (var j = 0; j < score_offers.length; j++) {
             result += score_offers[j].summ;
         }
    }
    return result;
}

function get_all_score(data, score) {
    return search_list_in_json(score, 'profile_id', data.id);
}

function get_wait_score(all_score, status_score) {

    var stat = search_in_json(status_score, 'name', 'В ожидании');

    return search_list_in_json(all_score, 'status_id', stat.id);
}

function get_count(wait_score, scoreoffers) {

    var result = 0;

    var scoreoffer = search_list_in_json_by_arr(scoreoffers, 'score_id' , get_list_of_elems(wait_score,'id'));

    for (var i = 0; i < scoreoffer.length; i++) {
        result += parseInt(scoreoffer[i]['summ']);
    }

    return result;
}

function uniqByKeepFirst(a, key) {
    let seen = new Set();
    return a.filter(item => {
        let k = key(item);
        return seen.has(k) ? false : seen.add(k);
    });
}

function get_balance(offers) {
    var result = 0;
    offers.forEach(function (item) {
        result += item.balance
    });
    return result;
}

function get_lead(offers) {
    var result = 0;
    offers.forEach(function (item) {
        result += item.leads_count
    });
    return result;
}


function get_day_pay(offers) {
    var result = 0;
    offers.forEach(function (item) {
        var date_now = new Date();

        var date_payment = date_format(item.payment_date);
        var date_percent = date_format(item.percent_date);

        var payment;
        if (date_payment!== null && date_payment < date_now) {
            payment = item.payment_new;
        } else {
            payment = item.payment;
        }

        var percent;
        if (date_percent!== null && date_percent < date_now) {
            percent = item.percent_new;
        } else {
            percent = item.percent;
        }
        result += parseInt(item.limit) * parseInt(payment) * (parseInt(percent) / 100);
    });
    return isNaN(result) ? '-----' : parseInt(result);
}

function get_avg_get(offers) {
    var result = 0, offers_count = 0;
    offers.forEach(function (item) {
        result += parseInt(item.percent);
        offers_count++;
    });
    if (offers_count !== 0) {
        result /= offers_count;
    }
    return result.toFixed(0);
}

function get_avg_real(offers, leads, lead_success) {
    var result = 0, real_count = 0, success_count = 0;
    var date = new Date();
    date.setDate(date.getDate() - 7);

    offers.forEach(function (item) {
        var lead = search_list_in_json(leads, 'offer_id', item.id);
        for (var k = 0; k < lead.length; k++) {
            var test_date = new Date(lead[k].date_create);
            if (test_date >= date) {
                real_count++;
                if (lead[k].status_id === lead_success.id) {
                    success_count++;
                }
            }
        }
    });

    if (real_count !== 0) {
        result = success_count / real_count;
        result *= 100;
    }
    return result.toFixed(0);
}


function if_phone() {
    return /Android|webOS|iPhone|iPod|Blackberry|Windows Phone/i.test(navigator.userAgent);
}

function summ_param(data, key, param, date) {
    var a = [];
    if (key != null && date != null) {
        a = search_list_in_json(data, key, date);
    } else {
        a = data
    }
    var b = 0;
    for (var i = 0; i < a.length; i++) {
        b += Number(a[i][param]);
    }
    return b
}

function count_param(data, date, param = null, value = null, tz=null) {

    var mass_with_date = search_list_in_json_with_date(data, 'date_create', date, tz);

    var mass_with_value = search_list_in_json(mass_with_date, param, value === null ? '' : value);
    var result = [];
    if (param !== null && value !== null) {
        result = mass_with_value;
    } else {
        result = mass_with_date;
    }
    return result.length
}

function count_param_lead_status(data, status, param, value, advertiser_id=null,date=null) {
    var stat = search_in_json(mass_with_status, 'name', status);
    
    var mass_with_lead = search_list_in_json(data, 'advertiser_id', advertiser_id);
    var mass_mith_lead = search_list_in_json(mass_with_lead, 'status_id', status === 'Новый'? null : stat['id']);

    var count = 0;
    var count_payment = 0;
    var count_payment_new = 0;

    var mass_total = search_list_in_json(mass_mith_lead, param, value);
    if(date !== null){
        mass_total.forEach(function (item) {
            if(item['date_create'] >= date){
                count_payment_new +=1
            }
            if(item['date_create'] < date){
                count_payment +=1
            }
        });
    }else{
         count += mass_total.length;
    }


    if(date !== null){
        return [count_payment, count_payment_new]
    }else {
        return count;
    }

}

function compare_arrays(ar1, ar2) {
    var result = [];
    for (var i = 0; i < ar1.length; i++) {
        if (is_in_array(ar1[i], ar2)) {
            result.push(ar1[i]);
        }
    }
    return result;
}

function uniqueVal(value, index, self) {
    return self.indexOf(value) === index;
}

function for_value_with_number_and_string(a, b) {
    if (a === null || a === undefined) {
        a = ''
    }
    if (b === null || b === undefined) {
        b = ''
    }

    if (is_int(a) && is_int(b)) {
        a = Number(a);
        b = Number(b);
        return compare_two_elements(a, b);
    } else if (is_int(monthToComparableNumber(a)) && is_int(monthToComparableNumber(b))) {
        a = monthToComparableNumber(a);
        b = monthToComparableNumber(b);
        return compare_two_elements(a, b);
    } else {
        a = a.toLocaleLowerCase();
        b = b.toLocaleLowerCase();
        return compare_two_elements(a, b);
    }
}


function monthToComparableNumber(date) {
    if (date === undefined || date === null || date === '') {
        return null;
    }

    date = date.split(' ');

    if (date.length === 0) {
        return null;
    }

    var timeParts = date[0].split(':');
    var dateParts = timeParts.length < 2 ? date[0].split('.') : date[1].split('.');
    var cellDate = timeParts.length < 2 ? new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]), 0, 0) :
        new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]), parseInt(timeParts[0]), parseInt(timeParts[1]));

    return cellDate.getTime();
}


function compare_two_elements(a, b) {
    if (a > b) {
        return 1;
    } else if (a < b) {
        return -1;
    } else if (a === b) {
        return 0;
    }
}

function getAllRows(grid_options) {
    var rowData = [];
    grid_options.api.forEachNodeAfterFilter(node => rowData.push(node.data));
    return rowData;
}

function init_charts_info(date_range, array, change_data_in_charts) {
    var data = {
        'csrfmiddlewaretoken': $($(tokenlist[0]).children()[0]).val(),
        'date_range': date_range,
    };
    array.forEach(function (item) {
        data[item] = true
    });

    ajax_message('/get_data_for_charts/', data, change_data_in_charts);
}

function randomString(i) {
    var rnd = '';
    while (rnd.length < i)
        rnd += Math.random().toString(36).substring(2);
    return rnd.substring(0, i);
}

function success_download_file(data) {
    var link = document.createElement('a');
    link.setAttribute('href', '' + data.file_url);
    link.setAttribute('download', '' + data.file_name);
    link.click();
    link.remove();
}

function validate(evt,elem) {
  var theEvent = evt || window.event;

  // Handle paste
  if (theEvent.type === 'paste') {
      key = event.clipboardData.getData('text/plain');
  } else {
  // Handle key press
      var key = theEvent.keyCode || theEvent.which;
      key = String.fromCharCode(key);
  }
  var value = $(elem).val() + key;
  if( parseFloat(value) > 2 || parseFloat(value) < 0){
      theEvent.returnValue = false;
  }
  var regex = /^\d*[.]?\d*$/;
  if( !regex.test(key)) {
    theEvent.returnValue = false;
    if(theEvent.preventDefault) theEvent.preventDefault();
  }
}